version: '3.8'

services:
  # ==================== Infrastructure ====================

  # Redis for event streaming
  redis:
    image: docker.io/redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Jaeger all-in-one for trace visualization
  jaeger:
    image: docker.io/jaegertracing/all-in-one:1.51
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"  # Jaeger UI

  # Grafana LGTM (Loki, Grafana, Tempo, Mimir) for logs and metrics
  grafana:
    image: docker.io/grafana/otel-lgtm:latest
    ports:
      - "3000:3000"   # Grafana UI

  # ==================== Graylog Stack ====================

  # MongoDB for Graylog metadata
  graylog-mongodb:
    image: docker.io/mongo:7.0
    restart: on-failure
    volumes:
      - graylog-mongodb-data:/data/db

  # Graylog DataNode (search backend)
  graylog-datanode:
    image: docker.io/graylog/graylog-datanode:7.0
    hostname: datanode
    environment:
      - GRAYLOG_DATANODE_NODE_ID_FILE=/var/lib/graylog-datanode/node-id
      - GRAYLOG_DATANODE_PASSWORD_SECRET=${GRAYLOG_PASSWORD_SECRET}
      - GRAYLOG_DATANODE_MONGODB_URI=mongodb://graylog-mongodb:27017/graylog
    ulimits:
      memlock:
        hard: -1
        soft: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - graylog-datanode-data:/var/lib/graylog-datanode
    ports:
      - "127.0.0.1:8999:8999"  # DataNode API
      - "127.0.0.1:9200:9200"  # OpenSearch API
    depends_on:
      - graylog-mongodb
    restart: on-failure

  # Graylog server
  graylog:
    image: docker.io/graylog/graylog:7.0
    hostname: graylog-server
    environment:
      - GRAYLOG_NODE_ID_FILE=/usr/share/graylog/data/config/node-id
      - GRAYLOG_PASSWORD_SECRET=${GRAYLOG_PASSWORD_SECRET}
      - GRAYLOG_ROOT_PASSWORD_SHA2=${GRAYLOG_ROOT_PASSWORD_SHA2}
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:9000
      - GRAYLOG_HTTP_EXTERNAL_URI=http://localhost:9000/
      - GRAYLOG_MONGODB_URI=mongodb://graylog-mongodb:27017/graylog
    volumes:
      - graylog-data:/usr/share/graylog/data
    ports:
      - "9000:9000"   # Graylog Web UI
      - "4317"        # OTLP gRPC (internal only)
    depends_on:
      - graylog-mongodb
      - graylog-datanode
    restart: on-failure

  # ==================== Central OTEL Collector ====================

  central-collector:
    image: docker.io/otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collectors/central-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      - COLLECTOR_API_KEY=${COLLECTOR_API_KEY}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT}
      - LGTM_ENDPOINT=grafana:4317
      - GRAYLOG_ENDPOINT=graylog:4317
    depends_on:
      - jaeger
      - grafana
      - graylog

  # ==================== Sidecar OTEL Collectors ====================

  gateway-collector:
    image: docker.io/otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collectors/sidecar-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      - COLLECTOR_NAME=gateway-collector
      - COLLECTOR_API_KEY=${COLLECTOR_API_KEY}
      - CENTRAL_COLLECTOR_ENDPOINT=central-collector:4318
    depends_on:
      - central-collector

  orchestrator-collector:
    image: docker.io/otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collectors/sidecar-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      - COLLECTOR_NAME=orchestrator-collector
      - COLLECTOR_API_KEY=${COLLECTOR_API_KEY}
      - CENTRAL_COLLECTOR_ENDPOINT=central-collector:4318
    depends_on:
      - central-collector

  worker-us-collector:
    image: docker.io/otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collectors/sidecar-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      - COLLECTOR_NAME=worker-us-collector
      - COLLECTOR_API_KEY=${COLLECTOR_API_KEY}
      - CENTRAL_COLLECTOR_ENDPOINT=central-collector:4318
    depends_on:
      - central-collector

  worker-eu-collector:
    image: docker.io/otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collectors/sidecar-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      - COLLECTOR_NAME=worker-eu-collector
      - COLLECTOR_API_KEY=${COLLECTOR_API_KEY}
      - CENTRAL_COLLECTOR_ENDPOINT=central-collector:4318
    depends_on:
      - central-collector

  worker-asia-collector:
    image: docker.io/otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collectors/sidecar-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      - COLLECTOR_NAME=worker-asia-collector
      - COLLECTOR_API_KEY=${COLLECTOR_API_KEY}
      - CENTRAL_COLLECTOR_ENDPOINT=central-collector:4318
    depends_on:
      - central-collector

  # ==================== Application Services ====================

  # Java Gateway Service
  gateway:
    build:
      context: ./services/gateway
    environment:
      - ORCHESTRATOR_URL=http://orchestrator:8001
      - OTEL_SERVICE_NAME=dns-gateway
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://gateway-collector:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      - OTEL_LOGS_EXPORTER=otlp
    ports:
      - "8080:8080"
    depends_on:
      - orchestrator
      - gateway-collector

  # Python Orchestrator Service
  orchestrator:
    build:
      context: ./services/orchestrator
    environment:
      - REDIS_URL=${REDIS_URL}
      - OTEL_SERVICE_NAME=dns-orchestrator
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://orchestrator-collector:4317
      - OTEL_LOGS_EXPORTER=otlp
    depends_on:
      - redis
      - orchestrator-collector

  # Go Worker Services (simulating different geo locations)

  worker-us-east:
    build:
      context: ./services/workers
    environment:
      - WORKER_LOCATION=us-east-1
      - REDIS_URL=${REDIS_URL}
      - OTEL_SERVICE_NAME=dns-worker-us-east-1
      - OTEL_EXPORTER_OTLP_ENDPOINT=worker-us-collector:4317
      - OTEL_LOGS_EXPORTER=otlp
    depends_on:
      - redis
      - worker-us-collector

  worker-eu-west:
    build:
      context: ./services/workers
    environment:
      - WORKER_LOCATION=eu-west-1
      - REDIS_URL=${REDIS_URL}
      - OTEL_SERVICE_NAME=dns-worker-eu-west-1
      - OTEL_EXPORTER_OTLP_ENDPOINT=worker-eu-collector:4317
      - OTEL_LOGS_EXPORTER=otlp
    depends_on:
      - redis
      - worker-eu-collector

  worker-asia-south:
    build:
      context: ./services/workers
    environment:
      - WORKER_LOCATION=asia-south-1
      - REDIS_URL=${REDIS_URL}
      - OTEL_SERVICE_NAME=dns-worker-asia-south-1
      - OTEL_EXPORTER_OTLP_ENDPOINT=worker-asia-collector:4317
      - OTEL_LOGS_EXPORTER=otlp
    depends_on:
      - redis
      - worker-asia-collector

volumes:
  graylog-mongodb-data:
  graylog-datanode-data:
  graylog-data:
